% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/build_reference_matrix.R
\name{build_reference_matrix}
\alias{build_reference_matrix}
\title{Build a Reference Matrix from Single-Color Controls}
\usage{
build_reference_matrix(
  input_folder = "scc",
  output_folder = "gating_and_spectrum_plots",
  save_qc_plots = TRUE,
  control_df = NULL,
  include_multi_af = FALSE,
  af_dir = "af",
  default_sample_type = "beads",
  cytometer = "Aurora",
  histogram_pct_beads = 0.98,
  histogram_direction_beads = "both",
  histogram_pct_cells = 0.35,
  histogram_direction_cells = "both",
  outlier_percentile = 0.02,
  debris_percentile = 0.02,
  bead_gate_scale = 1.3,
  histogram_min_x_log = 2,
  max_clusters = 6,
  min_cluster_proportion = 0.03,
  gate_contour_beads = 0.999999999,
  gate_contour_cells = 0.95,
  subsample_n = 5000
)
}
\arguments{
\item{input_folder}{Directory containing SCC `.fcs` files.}

\item{output_folder}{Directory where gating/spectrum plots are written.}

\item{save_qc_plots}{Logical; if `TRUE`, write FSC/SSC, histogram, and spectrum plots.}

\item{control_df}{Optional control mapping as a data.frame or CSV path.
Expected columns: `filename`, `fluorophore`, `channel`; `universal.negative` is optional.}

\item{include_multi_af}{Logical; if `TRUE`, include additional AF controls from `af_dir`.}

\item{af_dir}{Directory with extra AF controls when `include_multi_af = TRUE`.}

\item{default_sample_type}{Fallback type when filename heuristics are ambiguous (`"beads"` or `"cells"`).}

\item{cytometer}{Cytometer name used for channel alias resolution (for example `"Aurora"`).}

\item{histogram_pct_beads}{Histogram gate width for bead controls.}

\item{histogram_direction_beads}{Histogram gate direction for bead controls: `"both"`, `"left"`, or `"right"`.}

\item{histogram_pct_cells}{Histogram gate width for cell controls.}

\item{histogram_direction_cells}{Histogram gate direction for cell controls: `"both"`, `"left"`, or `"right"`.}

\item{outlier_percentile}{Upper-tail FSC/SSC filtering percentile.}

\item{debris_percentile}{Debris filtering percentile for cell controls.}

\item{bead_gate_scale}{Ellipse scaling factor for bead FSC/SSC gate.}

\item{histogram_min_x_log}{Reserved histogram lower x-limit parameter.}

\item{max_clusters}{Maximum number of GMM components tested.}

\item{min_cluster_proportion}{Minimum population proportion kept from GMM fit.}

\item{gate_contour_beads}{Contour probability for bead gating ellipse/hull.}

\item{gate_contour_cells}{Contour probability for cell gating ellipse/hull.}

\item{subsample_n}{Maximum number of events used for GMM fitting per file.}
}
\value{
Numeric matrix with rows = fluorophores and columns = detectors (normalized spectra).
}
\description{
Reads SCC FCS files, performs FSC/SSC gating and positive-peak histogram gating,
then computes one normalized spectrum per fluorophore.
}
\details{
This is the core matrix-construction step used before unmixing.
}
\examples{
\dontrun{
# Build matrix from SCC folder and control CSV
M <- build_reference_matrix(
  input_folder = "scc",
  output_folder = "spectrQC_outputs/build_reference_plots",
  control_df = "fcs_control_file.csv",
  cytometer = "Aurora"
)

# Build quickly without saving QC plots
M_fast <- build_reference_matrix(
  input_folder = "scc",
  save_qc_plots = FALSE
)
}
}
